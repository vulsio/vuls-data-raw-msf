{
	"name": "MS09-004 Microsoft SQL Server sp_replwritetovarbin Memory Corruption",
	"fullname": "exploit/windows/mssql/ms09_004_sp_replwritetovarbin",
	"rank": 400,
	"disclosure_date": "2008-12-09",
	"type": "exploit",
	"author": [
		"jduck <jduck@metasploit.com>"
	],
	"description": "A heap-based buffer overflow can occur when calling the undocumented\n        \"sp_replwritetovarbin\" extended stored procedure. This vulnerability affects\n        all versions of Microsoft SQL Server 2000 and 2005, Windows Internal Database,\n        and Microsoft Desktop Engine (MSDE) without the updates supplied in MS09-004.\n        Microsoft patched this vulnerability in SP3 for 2005 without any public\n        mention.\n\n        An authenticated database session is required to access the vulnerable code.\n        That said, it is possible to access the vulnerable code via an SQL injection\n        vulnerability.\n\n        This exploit smashes several pointers, as shown below.\n\n        1. pointer to a 32-bit value that is set to 0\n        2. pointer to a 32-bit value that is set to a length influenced by the buffer\n          length.\n        3. pointer to a 32-bit value that is used as a vtable pointer. In MSSQL 2000,\n          this value is referenced with a displacement of 0x38. For MSSQL 2005, the\n          displacement is 0x10. The address of our buffer is conveniently stored in\n          ecx when this instruction is executed.\n        4. On MSSQL 2005, an additional vtable ptr is smashed, which is referenced with\n          a displacement of 4. This pointer is not used by this exploit.\n\n        This particular exploit replaces the previous dual-method exploit. It uses\n        a technique where the value contained in ecx becomes the stack. From there,\n        return oriented programming is used to normalize the execution state and\n        finally execute the payload via a \"jmp esp\". All addresses used were found\n        within the sqlservr.exe memory space, yielding very reliable code execution\n        using only a single query.\n\n        NOTE: The MSSQL server service does not automatically restart by default. That\n        said, some exceptions are caught and will not result in terminating the process.\n        If the exploit crashes the service prior to hijacking the stack, it won't die.\n        Otherwise, it's a goner.",
	"references": [
		"OSVDB-50589",
		"CVE-2008-5416",
		"BID-32710",
		"MSB-MS09-004",
		"EDB-7501"
	],
	"platform": "Windows",
	"rport": 1433,
	"autofilter_ports": [
		1433,
		1434,
		1435,
		14330,
		2533,
		9152,
		2638
	],
	"autofilter_services": [
		"ms-sql-s",
		"ms-sql2000",
		"sybase"
	],
	"targets": [
		"Automatic",
		"MSSQL 2000 / MSDE SP0 (8.00.194)",
		"MSSQL 2000 / MSDE SP1 (8.00.384)",
		"MSSQL 2000 / MSDE SP2 (8.00.534)",
		"MSSQL 2000 / MSDE SP3 (8.00.760)",
		"MSSQL 2000 / MSDE SP4 (8.00.2039)",
		"MSSQL 2005 SP0 (9.00.1399.06)",
		"MSSQL 2005 SP1 (9.00.2047.00)",
		"MSSQL 2005 SP2 (9.00.3042.00)",
		"CRASHER"
	],
	"mod_time": "2020-10-02 17:38:06 +0000",
	"path": "/modules/exploits/windows/mssql/ms09_004_sp_replwritetovarbin.rb",
	"is_install_path": true,
	"ref_name": "windows/mssql/ms09_004_sp_replwritetovarbin",
	"check": true
}
